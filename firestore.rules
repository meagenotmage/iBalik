rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns a document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update, delete: if isOwner(userId);
      
      // User's challenges subcollection
      match /challenges/{challengeId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
      
      // User's badges subcollection
      match /badges/{badgeId} {
        allow read: if isAuthenticated();
        allow write: if isOwner(userId);
      }
    }
    
    // Challenge definitions (global)
    // Note: In production, restrict write to admin only
    match /challenge_definitions/{challengeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // TODO: Restrict to admin in production
    }
    
    // Badge definitions (global)
    // Note: In production, restrict write to admin only
    match /badge_definitions/{badgeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // TODO: Restrict to admin in production
    }
    
    // Lost items collection
    match /lost_items/{itemId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() && (
        // Item owner can update
        isOwner(resource.data.userId) ||
        // Or if updating status to 'claimed' with valid claimId
        (request.resource.data.status == 'claimed' && 
         request.resource.data.claimId != null) ||
        // Or if updating status to 'returned' (from approved claim)
        (request.resource.data.status == 'returned' &&
         isOwner(resource.data.userId))
      );
      allow delete: if isOwner(resource.data.userId);
    }
    
    // Claims collection
    match /claims/{claimId} {
      allow read: if isAuthenticated() && (
        // Claimer can read their own claims
        isOwner(resource.data.claimerId) ||
        // Founder can read claims for their items
        isOwner(resource.data.founderId)
      );
      
      allow create: if isAuthenticated() && 
        isOwner(request.resource.data.claimerId);
      
      allow update: if isAuthenticated() && (
        // Claimer can update their own pending claims (e.g., add proof)
        (isOwner(resource.data.claimerId) && 
         resource.data.status == 'pending') ||
        
        // Founder can approve/reject claims for their items
        (isOwner(resource.data.founderId) && 
         resource.data.status == 'pending' &&
         request.resource.data.status in ['approved', 'rejected']) ||
        
        // Founder can mark approved claims as completed (confirm return)
        (isOwner(resource.data.founderId) && 
         resource.data.status == 'approved' &&
         request.resource.data.status == 'completed')
      );
      
      allow delete: if isOwner(resource.data.claimerId) && 
        resource.data.status == 'pending';
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Activities collection
    match /activities/{activityId} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Game/Points collection
    match /game_data/{userId} {
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
